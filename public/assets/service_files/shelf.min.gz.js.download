var ShelfEvents={OPEN:"shelfOpen",CLOSE:"shelfClose",SHELF_OPENED:"shelfOpened",SHELF_CLOSED:"shelfClosed",CHANGE_INDEX:"changeIndex"},NewShelfEvents={OPEN:"newShelfOpen",CLOSE:"newShelfClose",OPEN_ITEM:"newShelfOpenItem",CLOSE_ITEM:"newShelfCloseItem",ITEM_LOADED:"newShelfItemLoaded",RELOAD_WITH_ITEM:"newShelfReloadWithItem"},SHELF_ITEM_RATIO=.765,SHELF_HEIGHT_BREAKPOINTS=[0,320,640],SHELF_ROWS=[1,2,4],SHELF_UPPER_MARGIN_PERCENT=7,SHELF_HEIGHT_PERCENT=23,SHELF_LEFT_MARGIN_PERCENT=30,SHELF_RIGHT_MARGIN_PERCENT=36,SHELF_ITEM_MARGIN_PERCENT=16,MAX_ITEM_WIDTH=89,MAX_ITEM_HEIGHT=116,HEIGHT_WIDTH_RATIO=1.3,ITEM_SPACING=15,SHELF_V_MARGIN=23,SHELF_H_MARGIN=46,SHELF_LEFT_MARGIN=27,SHELF_RIGHT_MARGIN=39,SHELF_HEIGHT=35,ITEM_SHELF_OFFSET=1,SHELF_NAV_BUTTON_WIDTH=26,ITEM_MARGINS=15,ShelfTemplates={listView:'<div id="shelfListView"></div>',shelf:'<div class="shelf-container"><div class="shelf"><div class="top"></div><div class="front"></div></div><div class="shadow-container"><div class="left-shadow-container"><div class="left-shadow"></div></div><div class="mid-shadow"></div><div class="right-shadow-container"><div class="right-shadow"></div></div></div></div>',itemView:'<div class="shelf-item" title="<%- name %>"></div>',row:'<div class="shelf-row"></div>',navView:'<div id="shelfNavView"><div class="shelf-nav left"></div><div class="shelf-nav right"></div></div>',tooltip:'<div class="shelf-tooltip"></div>',pageNum:'<div class="shelf-page-num"></div>',navButton:'<svg version="1.0" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="26px" height="26px" viewBox="-3 0 30 28" style="enable-background:new 0 0 26 26;" xml:space="preserve"><g><g><path style="fill:#FFFFFF; stroke:#6f7685; stroke-width:1;"            d="M13.1,0.2C5.9,0.2,0,6,0,13.2s5.9,13,13.1,13s13.1-5.8,13.1-13S20.4,0.2,13.1,0.2z M17.9,13.5l-7.3,7.2c-0.1,0.1-0.2,0.1-0.3,0.1s-0.2,0-0.3-0.1c-0.2-0.2-0.2-0.4,0-0.6l7-6.9l-7-6.9c-0.2-0.2-0.2-0.4,0-0.6s0.5-0.2,0.6,0l7.3,7.2C18.1,13.1,18.1,13.3,17.9,13.5z"/></g></g></svg>'},ShelfItemModel=Backbone.Model.extend({default:{size:[MAX_ITEM_WIDTH,MAX_ITEM_HEIGHT],item:[],status:""}}),ShelfListModel=Backbone.Model.extend({defaults:{currentPageIndex:0,noOfPages:0,itemsPerPage:1,items:[],newShelf:!1,size:[100,100]},getHeightBreakpointIndex:function(e){for(var t=0,i=SHELF_HEIGHT_BREAKPOINTS.length,s=i-1;t<i-1&&-1===s;)SHELF_HEIGHT_BREAKPOINTS[t]>=e&&SHELF_HEIGHT_BREAKPOINTS[t+1]<=e&&(s=t),t+=1;return s}}),ShelfModel=Backbone.Model.extend({}),ShelfNavigationModel=Backbone.Model.extend({defaults:{currentPageIndex:0,noOfPages:1}}),ShelfPageModel=Backbone.Model.extend({defaults:{index:0,hasNavigation:!1,itemViews:[],rows:1,columns:1,display:!1,maxItemsPerPage:1}}),ShelfPageNumberModel=Backbone.Model.extend({defaults:{currentPageIndex:0,noOfPages:1}}),Shelf=Backbone.View.extend({template:_.template(ShelfTemplates.shelf),initialize:function(){this.setElement(this.template())},render:function(){return this}}),ShelfItemView=Backbone.View.extend({events:{click:"handleItemClick"},template:_.template(ShelfTemplates.itemView),initialize:function(){this.setElement(this.template(this.model.attributes.item)),this.item=this.model.get("item"),this.itemCoverLoader=null},render:function(){var e=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth*HEIGHT_WIDTH_RATIO||MAX_ITEM_HEIGHT;return this.$el.css("margin-top",e-this.model.get("size")[1]),this.createItemCoverLoader(),this},createItemCoverLoader:function(){this.itemCoverLoader=new SimpleLoader({model:new SimpleLoaderModel({width:this.model.get("size")[0],height:this.model.get("size")[1],scaleMode:"scale"})}),this.listenTo(this.itemCoverLoader.model,"change:status",this.loadItemCoverShadows),this.listenTo(this.itemCoverLoader.model,"change",this.positionBookShadow),this.$el.append(this.itemCoverLoader.render().el)},load:function(){var e,t,i;FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelf")?e=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth&&FSWidgetModel.gi().get("collectionData").params.shelfItemWidth>MaxShelfThumbItemWidth?this.item.coverPath.replace("thumb","small"):this.item.coverPath:(t=FSWidgetModel.gi().widgetSettings.get("arabicStyle"),i=this.item.get("pages"),e=(t?i.at(i.length-1):i.at(0)).get("thumb")),this.itemCoverLoader.model.set("source",e)},handleItemClick:function(){this.model.get("newShelf")?(Backbone.Mediator.pub(WidgetEvent.ENTER_FULLSCREEN,{hash:this.model.get("item").hash}),Backbone.Mediator.pub(NewShelfEvents.OPEN_ITEM,this.model.get("item"))):this.trigger("click",this.model.get("item").get("itemIndex"))},loadItemCoverShadows:function(e,t){var i;t===ContentLoaderStatus.COMPLETE?(this.$el.addClass("visible"),i=$("<div/>").addClass("book-shadow"),this.$el.append(i)):t===ContentLoaderStatus.ERROR&&this.$el.addClass("blank").addClass("visible"),this.model.set("status",t),$(this).trigger(t)},positionBookShadow:function(e){var t,i,s;("imageWidth"in e.changed||"imageHeight"in e.changed)&&(i=this.itemCoverLoader.model.get("width"),s=this.itemCoverLoader.model.get("imageWidth"),6,t=Math.ceil((i-s)/2)-6,this.$el.find(".book-shadow").css("right",t+"px"))},isLoadComplete:function(){var e=this.model.get("status");return e===ContentLoaderStatus.COMPLETE||e===ContentLoaderStatus.ERROR}}),ShelfListView=Backbone.View.extend({template:_.template(ShelfTemplates.listView),initialize:function(){this.setElement(this.template()),this.loadManager=new LoaderManager,this.itemViews=[],this.createItemViews(),this.pages=[],this.resetPageViews(),this.resize(),this.listenTo(this.model,"change:size",this.resize),this.listenTo(this.model,"change",this.resetPageViews),this.listenTo(this.model,"change:currentPageIndex",this.showPage)},render:function(){return this},resize:function(){var e=this;this.$el.css({width:this.model.get("size")[0]+"px",height:this.model.get("size")[1]+"px",marginTop:SHELF_V_MARGIN+"px",maxWidth:this.model.get("maxWidth")+"px",left:"50%",transform:"translateX(-50%)"}),_.each(this.pages,(function(t){t.model.set("size",e.model.get("size"))}))},createItemViews:function(){for(var e,t=this.model.get("items"),i=0,s=t.length;i<s;i+=1)this.model.get("newShelf")?(e=$.extend(!0,{},t[i],{index:i}),this.itemViews.push(this.createItem(e))):this.itemViews.push(this.createItem(t.at(i))),this.itemViews[i].render(),this.itemViews[i].on("click",this.openItem,this)},destroyItemViews:function(){this.itemViews.forEach((function(e){e.off(),e.remove()})),this.itemViews=[]},createItem:function(e){var t=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth||MAX_ITEM_WIDTH,i=HEIGHT_WIDTH_RATIO*t,s=Math.min(i,this.getShelfItemHeight(t,e));return new ShelfItemView({model:new ShelfItemModel({newShelf:this.model.get("newShelf"),size:[t,s],item:e})})},getShelfItemHeight:function(e,t){var i,s,a;return FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelfOpened")?(i=t.width,s=t.height):(i=t.get("pages").at(0).get("width"),s=t.get("pages").at(0).get("height")),a=i/e,Math.round(s/a)},handleItemClick:function(e){this.trigger("openItem",e)},createPageViews:function(){for(var e,t=this.model.get("noOfPages"),i=this.model.get("itemsPerPage"),s=this.itemViews.length,a=0;a<t;a+=1)e=new ShelfPageView({model:new ShelfPageModel({index:a,hasNavigation:t>1,itemViews:this.itemViews.slice(a*i,Math.min(s,(a+1)*i)),rows:this.model.get("rows"),columns:this.model.get("columns"),shelfColor:FSWidgetModel.gi().get("collectionData").params.shelfColor||"#d1d1d1"})}),this.$el.append(e.render().$el),this.pages.push(e)},destroyPageViews:function(){this.pages.forEach((function(e){e.off(),e.remove()})),this.pages=[],this.$el.empty()},resetPageViews:function(){var e=this.model.changedAttributes();["noOfPages","itemsPerPage","rows","columns"].some((function(t){return t in e}))&&(this.destroyPageViews(),this.createPageViews(),this.showPage())},showPage:function(){var e=this.model.get("currentPageIndex");this.pages.forEach((function(t,i){t.model.set("display",i===e)})),this.resetLoaderTasks()},resetLoaderTasks:function(){var e,t=this.model.get("currentPageIndex"),i=this.pages.length,s=this;for(this.loadManager.removeAllTasks(),e=t;e<i;e+=1)this.pages[e].model.get("itemViews").forEach((function(e){s.loadManager.addTask(e)}));for(e=t-1;e>-1;e-=1)this.pages[e].model.get("itemViews").forEach((function(e){s.loadManager.addTask(e)}))},openItem:function(e){this.model.get("newShelf")?this.trigger("newShelfOpen",e):this.trigger("openItem",e)},remove:function(){this.loadManager.removeAllTasks(),this.loadManager=null,this.destroyPageViews(),this.destroyItemViews(),Backbone.View.prototype.remove.apply(this,arguments)}}),ShelfNavigationView=Backbone.View.extend({events:{"click .shelf-nav.left":"previousPage","click .shelf-nav.right":"nextPage"},template:_.template(ShelfTemplates.navView),initialize:function(){this.setElement(this.template()),this.$leftButton=this.$el.find(".left"),this.$rightButton=this.$el.find(".right"),this.$leftButton.append(_.template(ShelfTemplates.navButton)()),this.$rightButton.append(_.template(ShelfTemplates.navButton)()),this.listenTo(this.model,"change",this.updateNavControls),this.pageNumberModel=new ShelfPageNumberModel({currentPageIndex:this.model.get("currentPageIndex"),noOfPages:this.model.get("noOfPages")}),this.pageNumberView=new ShelfPageNumberView({model:this.pageNumberModel}),this.$el.find(".left").after(this.pageNumberView.render().el),this.pageNumberView.on(ShelfEvents.CHANGE_INDEX,this.updateIndex,this)},render:function(){return this.updateNavControls(),this},previousPage:function(){var e=this.model.get("currentPageIndex");e>0&&(e-=1,this.model.set("currentPageIndex",e),this.pageNumberModel.set("currentPageIndex",e))},nextPage:function(){var e=this.model.get("currentPageIndex");e<this.model.get("noOfPages")-1&&(e+=1,this.model.set("currentPageIndex",e),this.pageNumberModel.set("currentPageIndex",e))},updateNavControls:function(){var e=this.model.get("currentPageIndex"),t=this.model.get("noOfPages");1===t?this.$el.hide():this.$el.show(),0===e?this.$leftButton.addClass("disabled"):this.$leftButton.removeClass("disabled"),e===t-1?this.$rightButton.addClass("disabled"):this.$rightButton.removeClass("disabled"),this.pageNumberModel.set("noOfPages",t)},remove:function(){this.undelegateEvents(),Backbone.View.prototype.remove.apply(this,arguments)},updateIndex:function(e){this.model.set("currentPageIndex",e),this.pageNumberModel.set("currentPageIndex",e)}}),ShelfPageNumberView=Backbone.View.extend({template:_.template(ShelfTemplates.pageNum),initialize:function(){this.setElement(this.template()),this.listenTo(this.model,"change:currentPageIndex",this.updatePageBullets),this.listenTo(this.model,"change:noOfPages",this.createPageBullets),this.$el.on("click",this,this.onBulletClick)},render:function(){return this.createPageBullets(),this},createPageBullets:function(){var e,t,i=this.model.get("noOfPages");for(this.$el.empty(),t=0;t<i;t+=1)e='<span class="page-bullet'+(this.model.get("currentPageIndex")===t?" active":"")+(t===i-1?" last":"")+'" data-page='+t+"></span>",this.$el.append(e)},updatePageBullets:function(){this.$el.find(".active").removeClass("active"),this.$el.find("[data-page = "+this.model.get("currentPageIndex")+"]").addClass("active")},onBulletClick:function(e){$(e.target).hasClass("page-bullet")&&e.data.trigger(ShelfEvents.CHANGE_INDEX,parseInt($(e.target).attr("data-page"),10))}}),ShelfPageView=Backbone.View.extend({className:"shelf-page",initialize:function(){this.shelfViews=[],this.createElements(),this.setPageDisplayMode(),this.listenTo(this.model,"change:items",this.resetView),this.listenTo(this.model,"change:display",this.setPageDisplayMode),Backbone.Mediator.sub(WidgetEvent.CHANGE_SHELF_COLOR,this.handleShelfColorChange,this)},render:function(){return this},destroyShelves:function(){this.shelfViews.forEach((function(e){e.remove()})),this.shelfViews=[]},clearView:function(){this.destroyShelves(),this.$el.find(".shelf-item").detach(),this.$el.empty()},createShelves:function(){for(var e,t=this.model.get("itemViews"),i=t.length,s=this.model.get("columns"),a=Math.ceil(i/s),l=0,n=0,o=0;l<a;l+=1){for(e=$(_.template(ShelfTemplates.row)()),this.$el.append(e),n=0;n<s&&o<i;n+=1)e.append(t[o].$el),o+=1;this.shelfViews.push(new Shelf({model:{}})),e.append(this.shelfViews[l].render().$el)}},createElements:function(){this.createShelves(),this.setShelfColor()},resetView:function(){this.clearView(),this.createElements()},remove:function(){this.clearView(),Backbone.View.prototype.remove.apply(this,arguments)},setPageDisplayMode:function(){var e=this.model.get("display")?"flex":"none";this.$el.css("display",e)},setShelfColor:function(){var e=this.$el.find(".top");this.$el.find(".front").css({backgroundColor:this.model.get("shelfColor")}),e.css({borderBottomColor:this.model.get("shelfColor"),opacity:.76})},handleShelfColorChange:function(e){this.model.set("shelfColor",e),this.setShelfColor()}});!function(e){e.ShelfView=Backbone.View.extend({el:ComponentContainers.SHELF_VIEW,initialize:function(){FSWidgetModel.gi().widgetState.get("displayType"),DisplayType.SMALL,FSWidgetModel.gi().widgetState.get("displayState"),DisplayState.NORMAL;Backbone.Mediator.pub(ShelfEvents.OPEN),FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelfOpened")?this.items=FSWidgetModel.gi().get("shelfData").get("items"):this.items=FSWidgetModel.gi().flipCollection2.get("items"),this.isVisible=!1,this.createListView(),this.createNavigation(),Backbone.Mediator.sub(WidgetEvent.RESIZE,this.resize,this),Backbone.Mediator.sub(WidgetEvent.FULLSCREEN_CHANGED,this.open,this),this.listenTo(FSWidgetModel.gi().widgetState,"change:displayType",this.handleDisplayTypeChange),this.listenTo(this.model,"change",this.setListViewSize),this.listenTo(this.listModel,"change",this.updateNavigation),this.listenTo(this.navigationModel,"change:currentPageIndex",this.updateList),this.listView.on("openItem",this.openItem,this),this.render()},createListView:function(){var e=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth||MAX_ITEM_WIDTH;this.listModel=new ShelfListModel({newShelf:FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("shelf"),items:this.items,currentPageIndex:0,size:this.model.get("size"),maxWidth:(e+ITEM_MARGINS)*this.items.length+2*SHELF_H_MARGIN}),this.setListViewSize(),this.listView=new ShelfListView({model:this.listModel}),this.$el.append(this.listView.render().el)},createNavigation:function(){this.navigationModel=new ShelfNavigationModel({currentPageIndex:0,noOfPages:this.listView.model.get("noOfPages")}),this.navigationView=new ShelfNavigationView({model:this.navigationModel}),this.$el.append(this.navigationView.render().el)},render:function(){return this.$el.addClass("visible"),this.isVisible=!0,Backbone.Mediator.pub(ShelfEvents.SHELF_OPENED),this},calculateNumberOfPages:function(e){var t,i,s,a,l,n,o,h=this.items.length,d=this.model.get("size")[0],g=this.model.get("size")[1],r=d-2*SHELF_H_MARGIN-(e?2*SHELF_NAV_BUTTON_WIDTH:0),c=g-2*SHELF_V_MARGIN,m=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth||MAX_ITEM_WIDTH,f=FSWidgetModel.gi().get("collectionData").params.shelfItemWidth*HEIGHT_WIDTH_RATIO||MAX_ITEM_HEIGHT;return s=r-SHELF_LEFT_MARGIN-SHELF_RIGHT_MARGIN,a=Math.max(Math.floor((s+ITEM_SPACING)/(m+ITEM_SPACING)),1),l=f+SHELF_HEIGHT-ITEM_SHELF_OFFSET,n=c-SHELF_V_MARGIN,{size:[r,c],itemsPerPage:i=(o=Math.max(Math.floor(n/l),1))*a,noOfPages:t=Math.ceil(h/i),rows:o,columns:a,currentPageIndex:Math.min(this.listModel.get("currentPageIndex"),t-1)}},setListViewSize:function(){var e=this.calculateNumberOfPages();e.noOfPages>1&&(e=this.calculateNumberOfPages(!0)),this.listModel.set(e)},resize:function(){this.isVisible&&this.model.set("size",[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")])},updateNavigation:function(){var e=this.listModel.changedAttributes();("noOfPages"in e||"itemsPerPage"in e)&&this.navigationModel.set({currentPageIndex:this.listModel.get("currentPageIndex"),noOfPages:this.listModel.get("noOfPages")})},updateList:function(){this.listModel.set("currentPageIndex",this.navigationModel.get("currentPageIndex"))},openItem:function(e){Backbone.Mediator.pub(WidgetEvent.CHANGE_ITEM,e),Backbone.Mediator.pub(ShelfEvents.CLOSE),Backbone.Mediator.pub(WidgetEvent.ENTER_FULLSCREEN),this.close()},close:function(){this.isVisible&&(this.$el.removeClass("visible"),this.isVisible=!1,Backbone.Mediator.pub(ShelfEvents.SHELF_CLOSED))},open:function(e){var t=FSWidgetModel.gi().widgetState.get("displayType");this.isVisible||e.displayState!==DisplayState.NORMAL||t!==DisplayType.SMALL||(this.$el.addClass("visible"),this.isVisible=!0,Backbone.Mediator.pub(ShelfEvents.SHELF_OPENED))},handleDisplayTypeChange:function(){FSWidgetModel.gi().widgetState.get("displayType")===DisplayType.SMALL?this.open({displayState:FSWidgetModel.gi().widgetState.get("displayState")}):this.close()},remove:function(){this.listView.off(),this.listView.remove(),this.listView=null,this.navigationView.remove(),this.navigationView=null,Backbone.View.prototype.remove.apply(this,arguments)}}),ShelfView._instance=null,ShelfView.gi=function(){return ShelfView._instance||(ShelfView._instance=new ShelfView({model:new Backbone.Model({size:[FSWidgetModel.gi().get("width"),FSWidgetModel.gi().get("height")]})})),ShelfView._instance},Backbone.Mediator.sub(WidgetEvent.CONFIG_DONE,(function(){var e=FSWidgetModel.gi().widgetSettings.get("widgetType"),t=FSWidgetModel.gi().get("shelfData")&&FSWidgetModel.gi().get("shelfData").get("itemOpened"),i=FSWidgetModel.gi().get("forceWidget");if(e===WidgetType.SHELF&&!i){if(t)return;ShelfView.gi()}}),this),Backbone.Mediator.sub(WidgetEvent.DESTROY,(function(){ShelfView._instance&&(ShelfView.gi().remove(),ShelfView._instance=null)}),this)}(window);