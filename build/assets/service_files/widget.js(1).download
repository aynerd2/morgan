/*
Â©2012 Haley Marketing Group

Example Usage:
<script type="text/javascript" src="//cdn.haleymarketing.com/hmgembed/init.js"></script>
<script type="text/javascript">
    var hmgEmbedConf = {
        api_key: '123456',
        ssl: true
    };
    var hmgJBConfig = {
        container_id: 'jbspan',
        fields: 'field1,field2,field3,keywords'
    };
</script>

*/

(function() {

    // Localize jQuery variable
    var jQuery;
    var jsonp_url;
    
    /******** Load jQuery if not present *********/
    if (window.jQuery === undefined) {
        //console.log('need some jQuery');
        loadScript('https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js','scriptLoadHandler()');
    } else {
        // The jQuery version on the window is the one we want to use
        jQuery = window.jQuery;
        init2();
    }
    
    /******** Called once jQuery has loaded ******/
    function scriptLoadHandler() {
        jQuery = window.jQuery;
        // Load jQuery UI if not present
        //console.log('in scriptLoadHandler');
        init2();
    }
        
    function init2() { 
        // Restore $ and window.jQuery to their previous values and store the
        // new jQuery in our local jQuery variable
        //jQuery = window.jQuery.noConflict(true);
        
        //console.log('in init2');
        
        jQuery(document).ready(function($) { 
            // Check Config            
            // hmgEmbedConf.api_key is required         
            if (hmgEmbedConf.api_key && hmgJBConfig.container_id) { 
                // Get data from the server                
                jsonp_url = "https://api.haleymarketing.com/?key=" + hmgEmbedConf.api_key;
                makeQuery();  
            } else {
                alert('An API Key and Container Id are required.');
            }      
            
        });
    }
    
    /******** Our supporting functions ********/
    function makeQuery() {
        
        var q = jsonp_url + '&fn=js_form_wdget&fieldmap=' + hmgJBConfig.fieldmap;
        
        if (hmgEmbedConf.ssl) { 
            q += '&ssl=1';
        }
        
        q += '&callback=?';
        
        jQuery.getJSON(q, renderQuery);
    }
    
    function renderQuery(r) {
        jQuery('#hmgStatusBar').hide();
        if (r.results.status != "ok") {
            alert(r.results.xstatus);
        } else {            
            var formHTML = r.results.data;
            jQuery('#' + hmgJBConfig.container_id).append(formHTML);
        }
    } 
        
    function loadScript(src,callback) {
        
        var script_tag = document.createElement('script');
        script_tag.setAttribute("type","text/javascript");
        script_tag.setAttribute("src",src);
        if (script_tag.readyState) {
          script_tag.onreadystatechange = function () { // For old versions of IE
              if (this.readyState == 'complete' || this.readyState == 'loaded') {
                    if (callback) {
                        eval(callback);
                    }
              }
          };
        } else {
            if (callback) {
                console.log('script_tag.onload: ' + callback);
                script_tag.onload = function () { eval(callback); } ;
            }
        }
    
         // Try to find the head, otherwise default to the documentElement
        (document.getElementsByTagName("head")[0] || document.documentElement).appendChild(script_tag);
    
    }

})(); // We call our anonymous function immediately